<!DOCTYPE>
<html>
<head>
	<title>OIDC Callback</title>
</head>
<body>
You have reached an OIDC Callback page.
<a href="/">Home</a>
<script type="module">
const { apiClient, genUserManager } = await import("/config.js");

const url = new URL(window.location);
const code = url.searchParams.get("code");
const state = url.searchParams.get("state");
const iss = new URL(url.searchParams.get("iss"));

console.log(code);
console.log(state);
console.log(iss);

const idpConfigs = await apiClient.getOidcConfig();
const idp = idpConfigs.config.find((idp) => idp.issuer.toString() === iss.toString());
if (!idp) {
	throw new Error("Unable to identify IdP in callback");
}
const userManager = genUserManager(idp);

const user = await userManager.signinCallback();
const { refresh_token } = user;
const refresh = refresh_token.split(".").slice(0,2).map(atob).map((s) => JSON.parse(s));
console.log(JSON.stringify(refresh));
const exp = new Date(refresh[1].exp * 1000);
console.log(exp);

console.log(user);
window.location.href = "/";

</script>
</body>
</html>
